name: install and run in conda env

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    steps:
    - name: checkout
      uses: actions/checkout@v2
    - name: checkout flickr1d dataset
      uses: actions/checkout@v2
      with:
        repository: spokenlanguage/flickr1d
        path: data
    - name: Setup conda
      uses: s-weigand/setup-conda@master
      with:
        update-conda: true
        python-version: 3.7
        conda-channels: anaconda, conda-forge
    - run: conda --version
    - run: which python
    - run: conda install pytorch -c pytorch
    - run: pip install torchvision

    - name: Install the package
      run: pip install -e .
      env:
        CONDA_PREFIX: /usr/share/miniconda

    - name: Lint with flake8
      env:
        CONDA_PREFIX: /usr/share/miniconda
      run: |
        pip install flake8
        # stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Run some experiments, including coverage
      env:
        CONDA_PREFIX: /usr/share/miniconda
        FLICKR1D_DIR: ${{ github.workspace }}/data
        FLICKR8K_ROOT: ${{ github.workspace }}/data/flickr1d
        PLATALEA_EPOCHS: 1
      run: |
        pip install sklearn python-Levenshtein coverage nltk
        coverage run -m platalea.experiments.flickr8k.basic_default -c $FLICKR1D_DIR/config.yml
        coverage run -m platalea.experiments.flickr8k.transformer -c $FLICKR1D_DIR/config.yml
        coverage run -m platalea.experiments.flickr8k.asr -c $FLICKR1D_DIR/config.yml
        mkdir -p asr_out
        mv net.1.pt asr_out/net.best.pt
        coverage run -m platalea.experiments.flickr8k.mtl_asr -c $FLICKR1D_DIR/config.yml
        coverage run -m platalea.experiments.flickr8k.mtl_st -c $FLICKR1D_DIR/config.yml
        coverage run -m platalea.experiments.flickr8k.text_image -c $FLICKR1D_DIR/config.yml
        mkdir -p text_image_out
        mv net.1.pt text_image_out/net.best.pt
        coverage run -m platalea.experiments.flickr8k.pip_ind -c $FLICKR1D_DIR/config.yml --asr_model_dir=asr_out --text_image_model_dir=text_image_out
        coverage run -m platalea.experiments.flickr8k.pip_seq -c $FLICKR1D_DIR/config.yml --asr_model_dir=asr_out
        coverage xml

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v1
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        fail_ci_if_error: true
